<!doctype html>
  <head>
    <meta charset="utf-8">
    <title>Mathr Prototype</title>
    <meta name="description" content="Mathr Prototype">
    <meta name="viewport" content="width=device-width">
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <!-- build:css styles/vendor.css -->
    <!-- bower:css -->
    <!-- endbower -->
    <!-- endbuild -->

    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="styles/main.css">
    <!-- endbuild -->

    <link rel="stylesheet" href="styles/fonts.css">
    <link rel="stylesheet" href="http://quilljs.com/css/quill.snow.css" />

  </head>
  <body>
    <div class="container">

      <div class="row">
        <table data-table="1" class="table">
          <tr data-row="1"><td data-col="a">coffee</td> <td data-col="b">$4.00</td></tr>
          <tr data-row="2"><td data-col="a">milk</td> <td data-col="b">$3.75</td></tr>
          <tr data-row="3"><td data-col="a">water</td> <td data-col="b">$6.25</td></tr>
        </table>
      </div>

      <div class="row editor-container col-md-12" data-note="0">
        <div class="row">
          <div class="gutter col-md-1 col-xs-1"></div>
          <div class="editor col-md-6 col-xs-6" data-input="1">10.5 * $2
0 + 1.6666
5000 - 12.5
1000944.111 * 14
33 + l5
l8 * 2
l2 / 2
# testing
t1.b1
mathr: 5 * 5.5
$8.50 / 4

random(5)
</div>

          <div data-output="1" class="col-md-5 col-xs-5">-</div>
        </div>
      </div>

      <div class="row">
        <div data-output="error" class="col-md-12 alert"></div>
      </div>

    </div>

    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/affix.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/alert.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/button.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/carousel.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/collapse.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/dropdown.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/tab.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/transition.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/scrollspy.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/modal.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/tooltip.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/popover.js"></script>
    <script src="bower_components/bacon/dist/Bacon.js"></script>
    <script src="bower_components/numeral/numeral.js"></script>
    <!-- endbower -->
    <!-- endbuild -->

    <!-- build:js({.tmp,app}) scripts/scripts.js -->
    <script src="http://quilljs.com/js/quill.js"></script>

    <script src="bower_components/medium/medium.js"></script>
    <script src="bower_components/react/react.js"></script>
    <script src="bower_components/react/JSXTransformer.js"></script>
    <script src="scripts/grammars/mathr.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/mathr.js"></script>
    <!-- <script src="scripts/controllers/main.js"></script> -->
    <!-- endbuild -->

    <script type="text/javascript">
    /*globals $, Quill, parser, numeral*/
    'use strict';

    var __config = {
      lineHeight: 30,
    };

    var editor1 = new Quill('div[data-note="0"] [data-input].editor', {
      styles: {
        'body': {
          'font-family': 'Source Code Pro, ',
          'font-size': '18px',
          'white-space': 'pre',
          'line-height': '30px',
          'padding': 0,
          'height': 'auto',
          'overflow-y': 'hidden'
        },
        'html': {
          'height': 'auto'
        },
        'editor-container': {
          'height': 'auto'
        }
      },
      logLevel: 'debug',
      modules: {
        'multi-cursor': {}
      },
      formats: ['bold']
    });
    // console.log(editor1);

    function resizeEditorContainer(editor) {
      // console.log(editor);
      if (editor && editor.renderer && editor.renderer.container) {
        var container = $(editor.renderer.container);
        container.height(editor.root.clientHeight);
        container.attr('height', '');
      }
    }

    function fillGutter (editor) {
      // console.log(gutter, editor, output);
      var gutter = editor.siblings('div.gutter');
      var output = editor.siblings('[data-output]');
      gutter.height(editor.height());
      output.height(editor.height());

      var gCount = editor.height() / (__config.lineHeight - 0.0000001);
      var gNums = [];
      for (var i = 1; i < gCount; i++) {
        gNums.push('<a data-line="' + i + '" name="#l' + i + '" href="#l' + i + '">' + i + '</a>');
      }
      gutter.html(gNums.join('<br>'));
    }

    function displayError(msg) {
      var errCount;
      if (!errCount) {
        errCount = 0;
      }
      var $error = $('[data-output="error"]');
      $error.prepend('\n<br>' + (++errCount) + ': ' + msg);
      console.error(msg);
    }

    function solve(note, line, htmlCode) {
      var exp, val, el;
      if (line) {
        try {
          // <div class="row" data-note="0">
          // console.log([note, line, htmlCode]);
          el = $('div[data-note="' + note + '"] [data-input="' + line + '"]');
          // console.log(el);
          exp = htmlCode || el.val() || el.html() || '';
          exp = exp.replace(/(<([^>]+)>)/ig, '');

          if (exp) {
            // var parserSource = generator.generate({moduleName: "mathr"});
            val = parser.parse(exp);
          } else {
            return;
          }
        } catch (e) {
          val = '';
          displayError(e.stack);
        }
        $('[data-note="' + note + '"] [data-output="' + line + '"]').html(val).data('value', val);
      }
      return [exp, val];
    }

    editor1.on('renderer-update', function () { // d, t, e
      // console.log('ru', d, t, e);
      // console.log(this.editor);
      var self = this,
        $container = $(this.editor.renderer.container),
        note = $container.parent().parent('[data-note]').data('note');
      setTimeout(function () {
        solve(note, parseInt($container.data('input')), self.editor.innerHTML);
        resizeEditorContainer(self.editor);
        fillGutter($container);
      }, 20);
    }).on('text-change', function () { // d, t, e
      // console.log('tc', d, t, e);
      var $container = $(this.editor.renderer.container),
        note = $container.parent().parent('[data-note]').data('note');
      solve(note, parseInt($container.data('input')), this.editor.innerHTML);
      resizeEditorContainer(this.editor);
      fillGutter($container);
    }).on('pre-event', function () { // d, t, e
      // console.log('pe', d, t, e);
      // resizeEditorContainer(this.root, $('div[data-note="0"] [data-input]'));
      // fillGutter($('div[data-note="0"] [data-input]'));
    });

    $('.gutter').on('click', 'a', function (e) {
      e.preventDefault();
      var el = $(e.currentTarget);
      // var line = el.data('line');
      var editor = el.siblings('[data-input]');
      editor.focus()[0].setSelectionRange(0, 0, 'forward');

      for (var start = 0; start >= 0 && editor.html()[start] !== '\n'; --start) {
        editor.focus()[0].setSelectionRange(start, start, 'forward');
      }
    });

    // $('[data-note="0"][data-input="1"]').focus()[0].setSelectionRange(0, 0, 'forward');
    </script>

    <!-- <script type="text/jsx">
      /** @jsx React.DOM */
      React.renderComponent(
        <p>Hello, world!</p>,
        document.getElementById('o6')
      );
    </script> -->
    <!-- <script type="text/jsx">
      /** @jsx React.DOM */
      var TodoList = React.createClass({
        render: function() {
          var createItem = function(itemText) {
            return <li>{itemText}</li>;
          };
          return <ul>{this.props.items.map(createItem)}</ul>;
        }
      });
      var TodoApp = React.createClass({
        getInitialState: function() {
          return {output: [], input: ''};
        },
        onChange: function(e) {
          this.setState({text: e.target.value});
        },
        handleSubmit: function(e) {
          e.preventDefault();
          var nextItems = this.state.items.concat([this.state.text]);
          var nextText = '';
          this.setState({items: nextItems, text: nextText});
        },
        render: function() {
          return (
            <div>
              <h3>TODO</h3>
              <TodoList items={this.state.items} />
              <form onSubmit={this.handleSubmit}>
                <input onChange={this.onChange} value={this.state.text} />
                <button>{'Add #' + (this.state.items.length + 1)}</button>
              </form>
            </div>
          );
        }
      });
      React.renderComponent(<TodoApp />, mountNode);
    </script> -->

</body>
</html>