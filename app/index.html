<!doctype html>
  <head>
    <meta charset="utf-8">
    <title>Mathr Prototype</title>
    <meta name="description" content="Mathr Prototype">
    <meta name="viewport" content="width=device-width">
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <!-- build:css styles/vendor.css -->
    <!-- bower:css -->
    <!-- endbower -->
    <!-- endbuild -->

    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="styles/main.css">
    <!-- endbuild -->

    <link rel="stylesheet" href="styles/fonts.css">

  </head>
  <body>
    <div class="container" id="page1"></div>

    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/affix.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/alert.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/button.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/carousel.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/collapse.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/dropdown.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/tab.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/transition.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/scrollspy.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/modal.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/tooltip.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/popover.js"></script>
    <script src="bower_components/bacon/dist/Bacon.js"></script>
    <script src="bower_components/numeral/numeral.js"></script>
    <script src="bower_components/filtrex/filtrex.js"></script>
    <script src="bower_components/uuid-js/lib/uuid.js"></script>
    <!-- endbower -->
    <script src="http://quilljs.com/js/quill.js"></script>
    <script src="bower_components/react/react.js"></script>
    <script src="bower_components/react/JSXTransformer.js"></script>
    <script src="bower_components/fluxxor/build/fluxxor.js"></script>
    <!-- endbuild -->

    <!-- build:js({.tmp,app}) scripts/scripts.js -->
    <!-- <script src="scripts/grammars/mathr.js"></script> -->
    <script src="scripts/compiler.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/mathr.js"></script>
    <!-- <script src="scripts/controllers/main.js"></script> -->
    <!-- endbuild -->

    <script type="text/javascript">
    var __config = {
      lineHeight: 30,
      editors: [],
      errors: [],
      quillSetup: {
        styles: {
          'body': {
            'font-family': 'Source Code Pro, ',
            'font-size': '18px',
            'white-space': 'pre',
            'line-height': '30px',
            'padding': 0,
            'height': 'auto',
            'overflow-y': 'hidden'
          },
          'html': {
            'height': 'auto'
          },
          'editor-container': {
            'height': 'auto'
          }
        },
        logLevel: 'debug',
        modules: {
          'multi-cursor': {}
        },
        formats: ['bold']
      }
    };
    </script>

    <script type="text/jsx">
    /**
     * @jsx React.DOM
     */
    var PageStore = Fluxxor.createStore({
      actions: {
        "ADD_PAGE": "onAddPage",
        "ADD_PAGES": "onAddPages",
        "TOGGLE_PAGE": "onTogglePage",
        "UPDATE_PAGE": "onUpdatePage",
        "CLEAR_PAGES": "onClearPages",
        "GET_PAGES": "onGetPages"
      },

      initialize: function() {
        this.pages = [];
      },

      onAddPage: function(payload) {
        // console.log(payload)
        this.pages.push({
          id: payload.page.id || UUIDjs.create(4).toString(),
          type: payload.page.type,
          name: payload.page.name,
          input: payload.page.input,
          output: null,
          hidden: false
        });
        this.emit("change");
      },

      onAddPages: function(payload) {
        for (var i = 0, l = payload.pages.length; i < l; i++) {
          var page = payload.pages[i];
          this.pages.push({
            id: page.id || UUIDjs.create(4).toString(),
            type: page.type,
            name: page.name,
            input: page.input,
            output: null,
            hidden: false
          });
        }
        this.emit("change");
      },

      onTogglePage: function(payload) {
        payload.page.hidden = !payload.page.hidden;
        this.emit("change");
      },

      onUpdatePage: function(payload) {
        // console.log(payload)
        this.emit("change");
      },

      onClearPages: function() {
        this.pages = this.pages.filter(function(page) {
          return page.hidden;
        });
        this.emit("change");
      },

      onGetPages: function(payload) {
        $.ajax({
          url: payload.url,
          dataType: 'json',
          success: function(pages) {
            // this.setState({pages: pages});
            this.onAddPages({pages: pages});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(payload.url, status, err.toString());
          }.bind(this)
        });
      },

      getState: function() {
        return {
          pages: this.pages
        };
      }
    });

    var actions = {
      addPage: function(page) {
        this.dispatch("ADD_PAGE", {page: page});
      },

      addPages: function(pages) {
        this.dispatch("ADD_PAGES", {pages: pages});
      },

      togglePage: function(page) {
        this.dispatch("TOGGLE_PAGE", {page: page});
      },

      updatePage: function(page) {
        this.dispatch("UPDATE_PAGE", {page: page});
      },

      clearPages: function() {
        this.dispatch("CLEAR_PAGES");
      },

      getPages: function(url) {
        this.dispatch("GET_PAGES", {url: url});
      }
    };

    var stores = {
      PageStore: new PageStore()
    };

    var flux = new Fluxxor.Flux(stores, actions);

    var FluxMixin = Fluxxor.FluxMixin(React),
        FluxChildMixin = Fluxxor.FluxChildMixin(React),
        StoreWatchMixin = Fluxxor.StoreWatchMixin;



    var SheetColumn = React.createClass({
      render: function () {
        return (
          <td data-col={this.props.col}>{this.props.val}</td>
        );
      }
    });
    var SheetRow = React.createClass({
      render: function () {
        return (
          <tr data-row="{this.props.row}">
            <SheetColumn col="a" val={this.props.a} />
            <SheetColumn col="b" val={this.props.b} />
          </tr>
        );
      }
    });
    var Sheet = React.createClass({
      render: function () {
        return (
          <table data-table="1" className="table">
            <SheetRow row="1" a="coffee" b="$4.00" />
            <SheetRow row="2" a="milk" b="$3.75" />
            <SheetRow row="3" a="water" b="$6.25" />
          </table>
        );
      }
    });

    var ErrorItem = React.createClass({
      render: function () {
        return (
          <p>{this.props.text}</p>
        );
      }
    });
    var ErrorList = React.createClass({
      getInitialState: function() {
        return {data: [
          {text: 'I am an error.'},
          {text: 'I am another error.'},
        ]};
      },
      render: function () {
        return (
          <div data-output="error" className="col-md-12 alert">
            <ErrorItem text="I am an error." />
            <ErrorItem text="I am another error." />
          </div>
        );
      }
    });

    var GutterLine = React.createClass({
      render: function () {
        return (
          <a data-line={this.props.line} name={"l_"+this.props.id} href={"#l_"+this.props.id} key={this.props.id}>{this.props.line}</a>
        );
      }
    });
    var Gutter = React.createClass({
      countLines: function (rows) {
        var gNums = [];
        for (var i = 1; i < rows-1; i++) {
          gNums.push(i);
        }
        this.setState({lines: gNums});
      },
      componentWillMount: function() {
        this.countLines(this.props.rows);
      },
      componentWillReceiveProps: function (nextProps) {
        this.countLines(nextProps.rows);
      },
      render: function () {
        var gutterLines = this.state.lines.map(function (line) {
          return <GutterLine line={line} id={this.props.id+'_'+line} />;
        }.bind(this));
        return (
          <div className="gutter col-md-1 col-xs-1 m-note--gutter">
            {gutterLines}
          </div>
        );
      }
    });

    var EditorInput = React.createClass({
      resizeContainer: function () {
        if (this.rte && this.rte.editor.renderer) {
          var $container = this.rte.editor.renderer.container;
          $container.style.height = this.rte.root.clientHeight + 'px';
        }
      },
      editorUpdated: function (d, t, e) { // d, t, e
        // console.log([d, t, e]);
        var text = this.rte.getText();
        this.props.onInputUpdate(text);
        this.resizeContainer();
      },
      installRTE: function () {
        var node = this.getDOMNode();
        this.rte = new Quill(node, __config.quillSetup);

        if (this.props.input) {
          // this.rte.setContents({ value: this.props.input });
          this.rte.setHTML(this.props.input);
          // this.rte.insertText(0, this.props.input);
        }
        this.resizeContainer();

        this.rte
          .on('renderer-update', this.editorUpdated)
          .on('text-change', this.editorUpdated)
          .on('pre-event', function () { // d, t, e
            // console.log('pe', d, t, e);
          }.bind(this));
      },
      componentDidMount: function () {
        // console.log(this.props.input);
        if (!this.rte) {
          this.installRTE();
          if (this.props.input) {
            // this.rte.setContents({ value: this.props.input });
            this.rte.setHTML(this.props.input);
            // this.rte.insertText(0, this.props.input);
          }
          this.resizeContainer();
        }
      },
      componentWillReceiveProps: function (nextProps) {
        if (nextProps.input) {
          if (!this.rte) {
            this.installRTE();
          }
          // this.rte.setContents({ text: nextProps.input });
          this.rte.setHTML(nextProps.input);
          // this.rte.insertText(0, nextProps.input);
        }
      },
      render: function () {
        return (
          <div className="editor col-md-6 col-xs-6 m-note--input"></div>
        );
      }
    });
    var EditorOutput = React.createClass({
      render: function () {
        // console.log(this.props)
        var rawOutput = this.props && this.props.output ? this.props.output.replace(/\n/g, '<br>') : 'feed me.';

        return (
          <div className="col-md-5 col-xs-5 m-note--output" dangerouslySetInnerHTML={{__html: rawOutput}}></div>
        );
      }
    });

    var Note = React.createClass({
      mixins: [FluxChildMixin],

      solveLines: function (rawCode) {
        // console.log(rawCode);
        function stripTags (string) {
          if (!string) {
            return '';
          }
          string = string.replace(/<\/p>/ig, '\n');
          string = string.replace(/(<([^>]+)>)/ig, '');
          return string;
        }

        var compiled = [],
          rendered = {},
          rerendered = [],
          code = rawCode;
        code = stripTags(code);
        var lines = code.split('\n');

        // TODO: add tables
        rendered['t1.b1'] = 3; // just a test

        // first rendering pass
        lines.forEach(function (line, i) {
          try {
            compiled[i] = compileExpression(line);
            rendered['l' + (i + 1)] = compiled[i](rendered);
          } catch (e) {
            __config.errors.push(e);
          }
        });

        compiled.forEach(function (line, i) {
          try {
            rendered['l' + (i + 1)] = rerendered[i] = line(rendered);
            // rendered['l' + (i + 1)] = rerendered[i];
          } catch (e) {
            console.log(e);
            __config.errors.push(e);
          }
        });
        // console.log(rendered);

        return rerendered.join('\n');
      },

      handleInputUpdate: function (update) {
        // console.log('update:', update);
        // this.setState({
        //   input: update.input
        // });
        // this.setState({
        //   input: update.input,
        //   output: update.output
        // });
        console.log(this.props.item.input, update)
        if (update && this.props.item.input !== update) {
          this.props.item.input = update;
        }
        this.props.item.output = this.solveLines(update);
        // this.setState();
        // console.log(update, this.props.item)
        this.getFlux().actions.updatePage(this.props.item);
      },
      getInitialState: function() {
        return {};
      },
      render: function () {
        // console.log(this.props)
        return (
          <div className="row m-note m-note--container col-md-12">
            <h3 className="row m-note--hed">{this.props.item ? this.props.item.name : ''}</h3>
            <div className="row m-note--row">
              <Gutter id={this.props.item.id} rows={this.props.item.input ? this.props.item.input.split('\n').length : 5} />
              <EditorInput input={this.props.item.input ? this.props.item.input : ''} onInputUpdate={this.handleInputUpdate} />
              <EditorOutput output={this.props.item.output ? this.props.item.output : ''} />
            </div>
          </div>
        );
      }
    });
    var Func = React.createClass({
      mixins: [FluxChildMixin],

      handleInputUpdate: function (input) {
        // console.log('input update:', input);
        // this.setState({output: input.output});
      },
      render: function () {
        return (
          <div className="row m-func m-note--container col-md-12">
            <h3 className="row m-note--hed">{this.props.item ? this.props.item.name : ''}</h3>
            <div className="row m-note--row">
              <Gutter id={this.props.item.id} rows={10} />
              <EditorInput input={this.props.item ? this.props.item.input : ''} onInputUpdate={this.handleInputUpdate} />
            </div>
          </div>
        );
      }
    });



    var Page = React.createClass({
      mixins: [FluxMixin, StoreWatchMixin("PageStore")],

      getStateFromFlux: function() {
        var flux = this.getFlux();
        // console.log(flux)
        // Normally we'd use one key per store, but we only have one store, so
        // we'll use the state of the store as our entire state here.
        return flux.store("PageStore").getState();
      },

      componentWillMount: function() {
        // console.log(this);
        this.getFlux().actions.getPages(this.props.url);
      },
      getInitialState: function() {
        return {};
      },
      render: function () {
        //<Func item={this.state.pages[2]} />
        // console.log(this.state)
        var itemList = this.state.pages.map(function (item) {
          switch (item.type) {
            case 'note':
              return <Note item={item} key={item.id} />;
            case 'function':
              return <Func item={item} key={item.id} />;
            case 'table':
              return <Sheet item={item} key={item.id} />;
            default:
              return null;
          }
        });
        return (
          <div className="container">
            {itemList}
            <ErrorList />
          </div>
        );
      }
    });

    React.renderComponent(
      <Page url="/scripts/fixtures/pages.json" flux={flux} />,
      document.getElementById('page1')
    );
    </script>
</body>
</html>