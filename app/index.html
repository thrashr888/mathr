<!doctype html>
  <head>
    <meta charset="utf-8">
    <title>Mathr Prototype</title>
    <meta name="description" content="Mathr Prototype">
    <meta name="viewport" content="width=device-width">
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

    <!-- build:css styles/vendor.css -->
    <!-- bower:css -->
    <!-- endbower -->
    <!-- endbuild -->

    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="styles/main.css">
    <!-- endbuild -->

    <link rel="stylesheet" href="styles/fonts.css">
    <link rel="stylesheet" href="http://quilljs.com/css/quill.snow.css" />

  </head>
  <body>
    <div class="container">

      <div class="row">
        <table data-table="1" class="table" id="table1">
        </table>
      </div>

      <div class="row editor-container col-md-12" data-note="0" id="note1">
        <div class="row">
          <div class="gutter col-md-1 col-xs-1"></div>
          <div class="editor col-md-6 col-xs-6" data-input="1">10.5 * $2
0 + 1.6666
5000 - 12.5
1000944.111 * 14
33 + l3
l2 * 2
l4 / 2
# testing
# testing + 50 * 3
"testing" + 3
math:
math: + 5 + 5.5
t1.b1
$8.50 / 4
$22
random(5)</div>

          <div data-output="1" class="col-md-5 col-xs-5"></div>
        </div>
      </div>

      <div class="row" id="func1">
      </div>

      <div data-output="error" class="row col-md-12 alert" id="error1"></div>

    </div>

    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/affix.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/alert.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/button.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/carousel.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/collapse.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/dropdown.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/tab.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/transition.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/scrollspy.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/modal.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/tooltip.js"></script>
    <script src="bower_components/bootstrap-sass-official/vendor/assets/javascripts/bootstrap/popover.js"></script>
    <script src="bower_components/bacon/dist/Bacon.js"></script>
    <script src="bower_components/numeral/numeral.js"></script>
    <script src="bower_components/filtrex/filtrex.js"></script>
    <!-- endbower -->
    <script src="http://quilljs.com/js/quill.js"></script>
    <script src="bower_components/react/react.js"></script>
    <script src="bower_components/react/JSXTransformer.js"></script>
    <!-- endbuild -->

    <!-- build:js({.tmp,app}) scripts/scripts.js -->
    <script src="scripts/grammars/mathr.js"></script>
    <script src="scripts/compiler.js"></script>
    <script src="scripts/app.js"></script>
    <script src="scripts/mathr.js"></script>
    <!-- <script src="scripts/reactTest.jsx" type="text/jsx"></script> -->
    <!-- <script src="scripts/controllers/main.js"></script> -->
    <!-- endbuild -->

    <script type="text/jsx">
    /**
     * @jsx React.DOM
     */

    var SheetRow = React.createClass({
      render: function () {
        return (
          <tr data-row="{this.props.row}"><td data-col="a">{this.props.a}</td> <td data-col="b">{this.props.b}</td></tr>
        );
      }
    });
    var Sheet = React.createClass({
      render: function () {
        return (
          <table data-table="1" className="table">
            <SheetRow row="1" a="coffee" b="$4.00" />
            <SheetRow row="2" a="milk" b="$3.75" />
            <SheetRow row="3" a="water" b="$6.25" />
          </table>
        );
      }
    });

    React.renderComponent(
      <Sheet />,
      document.getElementById('table1')
    );

    var ErrorItem = React.createClass({
      render: function () {
        return (
          <p>{this.props.text}</p>
        );
      }
    });
    var ErrorList = React.createClass({
      render: function () {
        return (
          <div data-output="error" className="col-md-12 alert">
            <ErrorItem text="I am an error." />
            <ErrorItem text="I am another error." />
          </div>
        );
      }
    });
    React.renderComponent(
      <ErrorList />,
      document.getElementById('error1')
    );


    var Note = React.createClass({
      render: function () {
        return (
          <div className="row editor-container col-md-12" data-note="0">
            <div className="row">
              <div className="gutter col-md-1 col-xs-1"></div>
              <div className="editor col-md-6 col-xs-6" data-input="1">10.5 * $2
0 + 1.6666
5000 - 12.5
1000944.111 * 14
33 + l3
l2 * 2
l4 / 2
# testing
# testing + 50 * 3
"testing" + 3
math:
math: + 5 + 5.5
t1.b1
$8.50 / 4
$22
random(5)</div>

              <div data-output="1" className="col-md-5 col-xs-5"></div>
            </div>
          </div>
        );
      }
    });
    // React.renderComponent(
    //   <Note />,
    //   document.getElementById('note1')
    // );


    var Func = React.createClass({
      render: function () {
        var testFunc = 'function multiplyList (v, m) {\n\tfor(var i in v) {\n\t\ti = i * m;\n\t};\n\treturn v;\n};';
        return (
          <div className="row editor-container col-md-7" data-func="0">
            <div className="row">
              <div className="gutter col-md-1 col-xs-1"></div>
              <div className="editor col-md-6 col-xs-6" data-input="1">{{__html: testFunc}}</div>
            </div>
          </div>
        );
      }
    });
    React.renderComponent(
      <Func />,
      document.getElementById('func1')
    );
    </script>

    <script type="text/javascript">
    /*globals $, Quill, parser, compileExpression*/
    'use strict';

    var __init_data__ = [
      {
        id: 1,
        type: 'note',
        name: 'test note',
        input: ['10.5 * $2',
          '0 + 1.6666',
          '5000 - 12.5',
          '1000944.111 * 14',
          '33 + l3',
          'l2 * 2',
          'l4 / 2',
          '# testing',
          '# testing + 50 * 3',
          '"testing" + 3',
          'math:',
          'math: + 5 + 5.5',
          't1.b1',
          '$8.50 / 4',
          '$22',
          'random(5)']
      },
      {
        id: 2,
        type: 'table',
        name: 'groceries',
        input: [
          ['coffee', '$4.00'],
          ['milk', '$3.75'],
          ['water', '$6.25'],
        ]
      },
      {
        id: 3,
        type: 'function',
        name: 'multiplyList',
        input: 'function multiplyList (v, m) {\n\tfor(var i in v) {\n\t\ti = i * m;\n\t};\n\treturn v;\n};'
      }
    ];

    var __config = {
      lineHeight: 30,
      editors: [],
      errors: [],
      quillSetup: {
        styles: {
          'body': {
            'font-family': 'Source Code Pro, ',
            'font-size': '18px',
            'white-space': 'pre',
            'line-height': '30px',
            'padding': 0,
            'height': 'auto',
            'overflow-y': 'hidden'
          },
          'html': {
            'height': 'auto'
          },
          'editor-container': {
            'height': 'auto'
          }
        },
        logLevel: 'debug',
        modules: {
          'multi-cursor': {}
        },
        formats: ['bold']
      }
    };


    var noteManager = {
      noteByNumber: [],
      getNoteByNumber: function (number) {
        if (!this.noteByNumber[number]) {
          this.noteByNumber[number] = $('[data-note="' + number + '"]');
        }
        return this.noteByNumber[number];
      },
      getNoteByGutter: function (gutter) {
        return gutter.parent().parent().parent('[data-note]').data('note');
      },
      getEditorByGutter: function (gutter) {
        return gutter.siblings('[data-input]');
      },
      getNoteByEditor: function (editor) {
        return editor.parent().parent('[data-note]').data('note');
      }
    };


    function resizeEditorContainer(editor) {
      // console.log(editor);
      if (editor && editor.renderer && editor.renderer.container) {
        var container = $(editor.renderer.container);
        container.height(editor.root.clientHeight);
        container.attr('height', '');
      }
    }

    function fillGutter (editor) {
      // console.log(gutter, editor, output);
      var gutter = editor.siblings('div.gutter');
      var output = editor.siblings('[data-output]');
      gutter.height(editor.height());
      output.height(editor.height());

      var gCount = editor.height() / (__config.lineHeight - 0.0000001);
      var gNums = [];
      for (var i = 1; i < gCount; i++) {
        gNums.push('<a data-line="' + i + '" name="#l' + i + '" href="#l' + i + '">' + i + '</a>');
      }
      gutter.html(gNums.join('<br>'));
    }

    function displayError(msg) {
      var out = '\n<p style="border-top: 1px solid black;">';
      out += (new Date()).getHours() + '.';
      out += (new Date()).getMinutes() + '.';
      out += (new Date()).getSeconds() + ': ';
      out += msg;
      out += '</p>';
      $('[data-output="error"]').prepend(out);
      console.error(msg);
    }

    function stripTags (string) {
      string = string.replace(/<\/p>/ig, '\n');
      string = string.replace(/(<([^>]+)>)/ig, '');
      return string;
    }

    function solveLines(htmlCode) {
      // console.log(htmlCode);
      var compiled = [],
        rendered = {},
        rerendered = [],
        code = htmlCode;
      code = stripTags(code);
      var lines = code.split('\n');

      // TODO: add tables
      rendered['t1.b1'] = 3; // just a test

      // first rendering pass
      lines.forEach(function (line, i) {
        try {
          compiled[i] = compileExpression(line);
          rendered['l' + (i + 1)] = compiled[i](rendered);
        } catch (e) {
          __config.errors.push(e);
        }
      });

      compiled.forEach(function (line, i) {
        try {
          rendered['l' + (i + 1)] = rerendered[i] = line(rendered);
          // rendered['l' + (i + 1)] = rerendered[i];
        } catch (e) {
          console.log(e);
          __config.errors.push(e);
        }
      });

      // console.log(rendered);

      return rerendered.join('<br>');
    }

    function solve(note, line, htmlCode) {
      var exp, val, el;
      if (line) {
        try {
          // <div class="row" data-note="0">
          // console.log([note, line, htmlCode]);
          el = $('div[data-note="' + note + '"] [data-input="' + line + '"]');
          // console.log(el);
          exp = htmlCode || el.val() || el.html() || '';
          exp = stripTags(exp);

          if (exp) {
            // var parserSource = generator.generate({moduleName: "mathr"});
            val = parser.parse(exp);
          } else {
            return;
          }
        } catch (e) {
          val = '';
          displayError(e.stack);
        }
        $('[data-note="' + note + '"] [data-output="' + line + '"]').html(val).data('value', val);
      }
      return [exp, val];
    }

    function editorUpdated () { // d, t, e
      // console.log('ru', d, t, e);
      // console.log(this.editor);
      var self = this,
        $container = $(this.editor.renderer.container),
        note = $container.parent().parent('[data-note]').data('note'),
        line = parseInt($container.data('input'));
      setTimeout(function () {
        // solve(note, parseInt($container.data('input')), self.editor.innerHTML);
        var val = solveLines(self.editor.innerHTML);
        $('[data-note="' + note + '"] [data-output="' + line + '"]').html(val).data('value', val);

        resizeEditorContainer(self.editor);
        fillGutter($container);
      }, 20);
    }

    function selectLine (string, lineNum) {
      lineNum--; // array starts at 0
      var lines = string.split('\n');

      // calculate start/end
      var startPos = 0, endPos = string.length;
      for(var x = 0; x < lines.length; x++) {
        if (x === lineNum) {
            break;
        }
        startPos += (lines[x].length+1);
      }
      endPos = lines[lineNum].length + startPos;

      return [startPos, endPos];
    }


    $('div[data-note]').each(function () {
      var note = parseInt($(this).data('note'));

      __config.editors[note] = new Quill('div[data-note="0"] [data-input].editor', __config.quillSetup);

      __config.editors[note]
        .on('renderer-update', editorUpdated.bind(__config.editors[note]))
        .on('text-change', editorUpdated.bind(__config.editors[note]))
        .on('pre-event', function () { // d, t, e
          // console.log('pe', d, t, e);
        });
    });


    $('.gutter').on('click', 'a', function (e) {
      e.preventDefault();

      var el = $(e.currentTarget),
        note = noteManager.getNoteByGutter(el),
        exp = stripTags(__config.editors[note].editor.innerHTML),
        line = el.data('line'),
        linePos = selectLine(exp, line);

      location.hash = 'l' + line;

      __config.editors[note].setSelection(linePos[0], linePos[1]);
    });
    </script>

</body>
</html>